<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NexGen Air Battlespace</title>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            background: #f5f5f5;
            overflow: hidden;
        }
        h1 {
            text-align: center;
            margin: 10px 0;
        }
        #controls {
            text-align: center;
            margin: 10px 0;
        }
        #container {
            display: flex;
            height: calc(100vh - 80px);
        }
        #left-sidebar {
            width: 0;
            background: #fff;
            border-right: 1px solid #ccc;
            overflow-y: auto;
            transition: width 0.3s;
            padding: 0;
        }
        #left-sidebar.open {
            width: 400px;
            padding: 20px;
        }
        #right-sidebar {
            width: 0;
            background: #fff;
            border-left: 1px solid #ccc;
            overflow-y: auto; /* Enable scrolling */
            transition: width 0.3s;
            padding: 0 20px; /* Add padding for better readability */
        }
        #right-sidebar.open {
            width: 400px;
            padding: 20px;
        }
        #right-sidebar img {
            width: 100px;
            height: 100px;
            border-radius: 4px;
            margin-bottom: 10px;
        }
        #right-sidebar p, #right-sidebar ul {
            margin: 10px 0;
            line-height: 1.5; /* Improve text readability */
        }
        #graph {
            flex-grow: 1;
            height: 100%;
            border: 1px solid #ccc;
            background: #fff;
            position: relative;
        }
        .node text {
            font-size: 12px;
            fill: #000;
            text-anchor: middle;
        }
        .node image {
            cursor: pointer;
        }
        .link {
            stroke: #999;
            stroke-width: 2;
        }
        .link.link16 {
            stroke: blue;
            stroke-width: 3;
        }
        .close-btn {
            float: right;
            font-size: 20px;
            cursor: pointer;
            color: #aaa;
        }
        .error {
            color: red;
            text-align: center;
        }
        #left-sidebar, #right-sidebar {
            position: relative;
            resize: horizontal; /* Allow horizontal resizing */
            overflow: auto; /* Ensure content is scrollable */
            min-width: 200px; /* Set a minimum width */
            max-width: 600px; /* Set a maximum width */
        }

        #left-sidebar {
            border-right: 1px solid #ccc;
        }

        #right-sidebar {
            border-left: 1px solid #ccc;
        }

        .resize-handle {
            position: absolute;
            top: 0;
            right: 0;
            width: 5px;
            height: 100%;
            cursor: ew-resize; /* Horizontal resize cursor */
            background: rgba(0, 0, 0, 0.1); /* Optional: Visual indicator */
        }
    </style>
</head>
<body>
    <h1>NexGen Air Battlespace</h1>
    <div id="controls">
        <label for="missionFilter">Select Mission Set:</label>
        <select id="missionFilter">
            <option value="main">Main Overview</option>
        </select>
    </div>
    <div id="container">
        <div id="left-sidebar">
            <span class="close-btn" onclick="closeSidebar('left-sidebar')">×</span>
            <h2 id="mission-title"></h2>
            <p id="mission-description"></p>
            <h3>Entity Roles</h3>
            <div id="mission-roles"></div>
            <div class="resize-handle"></div>
        </div>
        <div id="graph"></div>
        <div id="right-sidebar">
            <span class="close-btn" onclick="closeSidebar('right-sidebar')">×</span>
            <img id="entity-image" src="" alt="Entity image">
            <h2 id="entity-title"></h2>
            <p id="entity-description"></p>
            <h3>Capabilities</h3>
            <ul id="entity-capabilities"></ul>
            <h3>Missions</h3>
            <ul id="entity-missions"></ul>
            <div id="entity-extra"></div>
            <div class="resize-handle"></div>
        </div>
    </div>
    <script>
        // Data storage
        let entities = [];
        let missions = [];
        let currentMission = 'main';
        let customLinks = [];

        // Modular function to add a new node
        function addNode({ id, name, type, image, capabilities, description, missions, extra = {} }) {
            entities.push({
                id,
                name,
                type: type || 'Unknown',
                image: image || 'https://via.placeholder.com/100',
                capabilities: capabilities || [],
                description: description || 'No description available.',
                missions: missions || [],
                extra
            });
        }

        // Modular function to define custom layout
        function setLayout(missionId, layoutType, options = {}) {
            const mission = missions.find(m => m.id === missionId) || { id: missionId, layout: [] };
            let nodes = mission.layout.map(l => entities.find(e => e.id === l.id)).filter(Boolean);
            if (missionId === 'main') nodes = entities;

            if (layoutType === 'circle') {
                const { cx, cy, radius } = options;
                arrangeCircle(nodes, cx, cy, radius);
            } else if (layoutType === 'matrix') {
                const { rows, cols, startX, startY, spacingX, spacingY } = options;
                arrangeMatrix(nodes, rows, cols, startX, startY, spacingX, spacingY);
            } else if (layoutType === 'custom') {
                nodes.forEach((node, i) => {
                    if (options.positions && options.positions[i]) {
                        node.x = options.positions[i].x;
                        node.y = options.positions[i].y;
                    }
                });
            }
            mission.layout = nodes.map(n => ({ id: n.id, x: n.x, y: n.y }));
            if (!missions.find(m => m.id === missionId)) missions.push(mission);
        }

        // Modular function to add inter-node connections
        function addLink(sourceId, targetId, type = 'normal') {
            customLinks.push({ source: sourceId, target: targetId, type });
        }

        // Modular function to customize sidebar profile
        function renderSidebarProfile(d) {
            const sidebar = document.getElementById('right-sidebar');
            sidebar.classList.add('open');

            document.getElementById('entity-title').textContent = d.name || 'Unknown';
            document.getElementById('entity-description').textContent = d.description || 'No description available.';
            document.getElementById('entity-image').src = d.image || 'https://via.placeholder.com/100';

            const capList = document.getElementById('entity-capabilities');
            capList.innerHTML = '';
            (d.capabilities || []).forEach(cap => {
                const li = document.createElement('li');
                li.textContent = cap;
                capList.appendChild(li);
            });

            const missionList = document.getElementById('entity-missions');
            missionList.innerHTML = '';
            (d.missions || []).forEach(m => {
                const li = document.createElement('li');
                li.textContent = missions.find(mission => mission.id === m)?.name || m;
                missionList.appendChild(li);
            });

            const extraDiv = document.getElementById('entity-extra');
            extraDiv.innerHTML = '';
            if (d.extra) {
                Object.entries(d.extra).forEach(([key, value]) => {
                    const p = document.createElement('p');
                    p.innerHTML = `<strong>${key}:</strong> ${value}`;
                    extraDiv.appendChild(p);
                });
            }
        }

        // Load data
        Promise.all([
            fetch('entities.json').then(res => {
                if (!res.ok) throw new Error('Failed to load entities.json');
                return res.json();
            }),
            fetch('missions.json').then(res => {
                if (!res.ok) throw new Error('Failed to load missions.json');
                return res.json();
            })
        ]).then(([entitiesData, missionsData]) => {
            entities = entitiesData;
            missions = missionsData;

            // Populate mission filter
            const missionFilter = document.getElementById('missionFilter');
            missions.forEach(m => {
                const option = document.createElement('option');
                option.value = m.id;
                option.textContent = m.name;
                missionFilter.appendChild(option);
            });

            // Initialize visualization
            renderVisualization();
        }).catch(error => {
            console.error('Error loading data:', error);
            document.getElementById('graph').innerHTML = `<p class="error">Error loading data: ${error.message}. Please ensure entities.json and missions.json are present.</p>`;
        });

        // Helper functions for layout
        function arrangeCircle(nodes, cx, cy, radius) {
            if (!nodes.length) return;
            const angleStep = (2 * Math.PI) / nodes.length;
            nodes.forEach((node, i) => {
                node.x = cx + radius * Math.cos(i * angleStep);
                node.y = cy + radius * Math.sin(i * angleStep);
            });
        }

        function arrangeMatrix(nodes, rows, cols, startX, startY, spacingX, spacingY) {
            if (!nodes.length) return;
            nodes.forEach((node, i) => {
                const row = Math.floor(i / cols);
                const col = i % cols;
                node.x = startX + col * spacingX;
                node.y = startY + row * spacingY;
            });
        }

        // Main rendering function
        function renderVisualization() {
            const graphDiv = document.getElementById('graph');
            const width = graphDiv.clientWidth;
            const height = graphDiv.clientHeight;

            // Clear previous SVG
            d3.select('#graph').selectAll('*').remove();

            const svg = d3.select('#graph')
                .append('svg')
                .attr('width', width)
                .attr('height', height);

            const zoomGroup = svg.append('g');
            svg.call(d3.zoom().scaleExtent([0.5, 2]).on('zoom', (event) => {
                zoomGroup.attr('transform', event.transform);
            }));

            let nodes = [];
            let links = [];

            if (currentMission === 'main') {
                // hide the left sidebar and remove the 'entity roles'
                document.getElementById('left-sidebar').classList.remove('open');
                document.getElementById('mission-roles').innerHTML = '';
                // make the left sidebar width 0
                document.getElementById('left-sidebar').style.width = '0';
    

               

                // Main page: Group by type
                nodes = entities.map(e => ({ ...e }));
                links = [...customLinks];

                // Group entities by type
                const types = [...new Set(entities.map(e => e.type))];
                const groups = types.map(t => nodes.filter(n => n.type === t));

                // Layout groups dynamically
                groups.forEach((group, i) => {
                    if (group.length === 0) return;
                    const cols = Math.ceil(Math.sqrt(group.length));
                    const rows = Math.ceil(group.length / cols);
                    const startX = width * (0.1 + (i % 3) * 0.3);
                    const startY = height * (0.2 + Math.floor(i / 3) * 0.4);
                    arrangeMatrix(group, rows, cols, startX, startY, 200, 200);
                });

                // Add example links (e.g., Link 16 between C2 and others)
                const c2Nodes = nodes.filter(n => n.type === 'C2');
                const otherNodes = nodes.filter(n => n.type !== 'C2');
                c2Nodes.forEach(c => {
                    otherNodes.forEach(o => {
                        if (!links.some(l => l.source === o.id && l.target === c.id)) {
                            links.push({ source: o.id, target: c.id, type: 'Link16' });
                        }
                    });
                });
            } else {
                // Open the left sidebar for mission sets
                const sidebar = document.getElementById('left-sidebar');
                sidebar.classList.add('open');

                const mission = missions.find(m => m.id === currentMission);
                if (!mission) return;
                nodes = mission.layout.map(l => {
                    const entity = entities.find(e => e.id === l.id);
                    return entity ? { ...entity, x: l.x, y: l.y } : null;
                }).filter(n => n);
                links = mission.links.map(l => ({
                    source: l.source,
                    target: l.target,
                    type: 'Link16'
                }));

                // Update left sidebar content
                document.getElementById('mission-title').textContent = mission.name;
                document.getElementById('mission-description').textContent = mission.description;

                const rolesDiv = document.getElementById('mission-roles');
                rolesDiv.innerHTML = '';
                nodes.forEach(n => {
                    const role = document.createElement('div');
                    role.innerHTML = `<strong>${n.name}:</strong> ${getRoleDescription(n.id, mission.id)}`;
                    rolesDiv.appendChild(role);
                });
            }

            // Draw links
            const linkSelection = zoomGroup.selectAll('.link')
                .data(links)
                .enter()
                .append('line')
                .attr('class', d => `link ${d.type === 'Link16' ? 'link16' : ''}`)
                .attr('x1', d => {
                    const source = nodes.find(n => n.id === d.source);
                    return source ? source.x : 0;
                })
                .attr('y1', d => {
                    const source = nodes.find(n => n.id === d.source);
                    return source ? source.y : 0;
                })
                .attr('x2', d => {
                    const target = nodes.find(n => n.id === d.target);
                    return target ? target.x : 0;
                })
                .attr('y2', d => {
                    const target = nodes.find(n => n.id === d.target);
                    return target ? target.y : 0;
                });

            // Draw nodes
            const nodeSelection = zoomGroup.selectAll('.node')
                .data(nodes)
                .enter()
                .append('g')
                .attr('class', 'node')
                .attr('transform', d => `translate(${d.x || 0},${d.y || 0})`);

            nodeSelection.append('image')
                .attr('xlink:href', d => d.image || 'https://via.placeholder.com/60')
                .attr('width', 60)
                .attr('height', 60)
                .attr('x', -30)
                .attr('y', -30)
                .on('click', (event, d) => {
                    console.log('Clicked node:', d);
                    renderSidebarProfile(d); // Open the profile in the right sidebar
                });

            nodeSelection.append('text')
                .attr('y', 40)
                .text(d => d.name);

            // Mission filter event
            document.getElementById('missionFilter').onchange = function() {
                currentMission = this.value;
                document.getElementById('left-sidebar').classList.remove('open');
                document.getElementById('right-sidebar').classList.remove('open');
                renderVisualization();
            };
        }

        // Close sidebar
        function closeSidebar(id) {
            const sidebar = document.getElementById(id);
            if (sidebar) {
                sidebar.classList.remove('open');
            }
        }

        // Role descriptions for missions
        function getRoleDescription(entityId, missionId) {
            // Find the entity in the entities array
            const entity = entities.find(e => e.id === entityId);

            // If the entity exists, return its description
            if (entity) {
                return entity.description || 'No description available.';
            }

            // If the entity is not found, return a default message
            return 'Entity description not found.';
        }

        // Example usage of modular functions (uncomment to test)
        /*
        addNode({
            id: 'newdrone',
            name: 'New Drone',
            type: 'UCAV',
            image: 'https://via.placeholder.com/100',
            capabilities: ['Stealth', 'Surveillance'],
            description: 'A new experimental drone.',
            missions: ['ISR'],
            extra: { Status: 'Prototype', Range: '2000 miles' }
        });

        setLayout('main', 'matrix', {
            rows: 2,
            cols: 5,
            startX: 100,
            startY: 100,
            spacingX: 200,
            spacingY: 200
        });

        addLink('newdrone', 'link16', 'Link16');
        renderVisualization();
        */

        // Resize sidebar functionality
        document.querySelectorAll('.resize-handle').forEach(handle => {
            handle.addEventListener('mousedown', (event) => {
                const sidebar = handle.parentElement;
                const isLeftSidebar = sidebar.id === 'left-sidebar';
                const startX = event.clientX;
                const startWidth = sidebar.offsetWidth;

                function onMouseMove(e) {
                    const delta = e.clientX - startX;
                    if (isLeftSidebar) {
                        sidebar.style.width = `${startWidth + delta}px`;
                    } else {
                        sidebar.style.width = `${startWidth - delta}px`;
                    }
                }

                function onMouseUp() {
                    document.removeEventListener('mousemove', onMouseMove);
                    document.removeEventListener('mouseup', onMouseUp);
                }

                document.addEventListener('mousemove', onMouseMove);
                document.addEventListener('mouseup', onMouseUp);
            });
        });
    </script>
</body>
</html>